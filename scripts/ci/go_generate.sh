#!/usr/bin/env bash

# It is recommended to run in a linux environment.

set -e

go generate -x ./...

# for goyacc
for i in `find . -name "*.y"`
do
  cd `dirname $i`
  goyacc `basename $i`
  # set ErrorVerbose=ture
  sed -i 's/yyErrorVerbose = false/yyErrorVerbose = true/g' y.go
  # move 'import package' together
  sed -i 's/import __yyfmt__ "fmt"/	__yyfmt__ "fmt"/g' y.go
  yyfmtLineNum=`grep '__yyfmt__ "fmt"' y.go -n | awk -v FS=':' '{print $1}'`
  importLineNum=`grep "import (" y.go -n | awk -v FS=':' '{print $1}'`
  sed -i "${yyfmtLineNum}{h;d};${importLineNum}G" y.go
  sed -i "${importLineNum}G" y.go
  cd -
done

GIT_STATUS=$(git status | grep "Changes not staged for commit") || echo ""
if [[ "$GIT_STATUS" = "" ]]; then
  echo "code already generated by go generate -x ./... AND goyacc *.y"
else
  echo ""
  echo "check generated failed, please generate your code using go generate -x ./..."
  echo "git diff files:"
  git diff --stat | tee
  echo "git diff details: "
  git diff | tee
  exit 1
fi


